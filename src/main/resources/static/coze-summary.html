<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Coze 内容处理工具</title>
    <!-- 引入Bootstrap样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 1000px;
            margin-top: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .result-area {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        .alert-danger {
            display: none; /* 初始隐藏错误提示 */
        }
        .custom-query {
            margin-top: 10px;
            display: none; /* 默认隐藏自定义输入框 */
        }
        .result-card {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: white;
        }
        .result-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">Coze 内容处理工具</h2>

    <!-- 错误提示区域 -->
    <div class="alert alert-danger" id="errorAlert" role="alert"></div>

    <!-- 表单区域 -->
    <form id="cozeForm" class="needs-validation" novalidate>
        <!-- 1. 文件上传 -->
        <div class="form-group">
            <label for="file" class="form-label">上传文件（可选，支持txt、pdf等格式）</label>
            <input type="file" class="form-control" id="file" name="file" accept=".txt,.pdf,.doc,.docx,.md">
            <div class="form-text">若上传文件，将优先解析文件内容；可与文本输入同时使用</div>
        </div>

        <!-- 2. 文本输入 -->
        <div class="form-group">
            <label for="text" class="form-label">输入文本（可选）</label>
            <textarea class="form-control" id="text" name="text" rows="5" placeholder="请输入需要处理的文本内容..."></textarea>
            <div class="form-text">若不上传文件，可直接输入文本内容</div>
        </div>

        <!-- 3. 查询需求 -->
        <div class="form-group">
            <label for="queryType" class="form-label">内容类型/处理需求（可填）</label>
            <select class="form-select" id="queryType">
                <option value="">-- 选择常见类型 --</option>
                <option value="新闻">新闻（如：提取新闻核心事件、总结新闻要点）</option>
                <option value="小说">小说（如：分析人物关系、总结章节剧情）</option>
                <option value="论文">论文（如：提炼摘要、整理核心论点）</option>
                <option value="博客">博客（如：概括文章观点、提取实用建议）</option>
                <option value="自定义">自定义需求</option>
            </select>
            <div class="custom-query">
                <input type="text" class="form-control mt-2" id="customQuery" placeholder="输入你的自定义需求...">
            </div>
            <div class="form-text mt-1">选择类型后，系统将按对应场景处理；自定义需求可输入更具体的指令</div>
        </div>

        <!-- 4. 提交按钮 -->
        <button type="button" class="btn btn-primary" id="submitBtn">提交处理</button>
        <button type="reset" class="btn btn-secondary ms-2">重置</button>
    </form>

    <!-- 5. 结果展示区域（优化：结构化展示title、summary、image） -->
    <div class="result-area">
        <h5>处理结果：</h5>
        <div id="resultContainer" class="d-none">
            <div class="result-card">
                <h3 id="resultTitle" class="fw-bold text-primary"></h3>
                <p id="resultSummary" class="mt-3"></p>
                <img id="resultImage" class="result-image" alt="生成的图片">
            </div>
        </div>
        <div id="loadingMessage">请提交内容进行处理...</div>
    </div>
</div>

<!-- 引入依赖 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(function () {
        // 显示/隐藏自定义输入框
        $("#queryType").change(function () {
            const selected = $(this).val();
            if (selected === "自定义") {
                $(".custom-query").show();
                $("#customQuery").focus();
            } else {
                $(".custom-query").hide();
                $("#customQuery").val("");
            }
        });

        // 提交按钮点击事件
        $("#submitBtn").click(function () {
            // 获取参数
            const file = $("#file")[0].files[0];
            const text = $("#text").val().trim();
            const queryType = $("#queryType").val();
            const customQuery = $("#customQuery").val().trim();

            // 构建查询参数
            let query = "";
            if (queryType && queryType !== "自定义") {
                const typeMap = {
                    "新闻": "请总结该新闻的核心事件、时间、人物及关键结果",
                    "小说": "请分析该小说片段的人物性格、情节冲突及核心主题",
                    "论文": "请提炼该论文的研究目的、方法、核心结论及创新点",
                    "博客": "请概括该博客的主要观点，并整理出实用建议或结论"
                };
                query = typeMap[queryType];
            } else if (queryType === "自定义" && customQuery) {
                query = customQuery;
            }

            // 验证至少有文件或文本
            if (!file && !text) {
                showError("请上传文件或输入文本内容（至少需要一项）");
                return;
            }

            // 构建表单数据
            const formData = new FormData();
            if (file) formData.append("file", file);
            if (text) formData.append("text", text);
            if (query) formData.append("query", query);

            // 发送请求到后端
            $.ajax({
                url: "/coze/summary",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function () {
                    $("#submitBtn").prop("disabled", true).text("处理中...");
                    $("#resultContainer").addClass("d-none");
                    $("#loadingMessage").text("正在处理，请稍候...").removeClass("d-none");
                    hideError();
                },
                success: function (response) {
                    // 成功：解析结构化响应并展示
                    try {
                        // 处理JSON响应（假设后端返回JSON格式）
                        displayResult(response);
                    } catch (error) {
                        // 若解析失败，可能是纯文本响应，直接显示
                        console.error("解析响应失败:", error);
                        $("#resultTitle").text("处理结果");
                        $("#resultSummary").text(response);
                        $("#resultImage").attr("src", "").addClass("d-none");
                        $("#resultContainer").removeClass("d-none");
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseText || "处理失败，请重试";
                    showError(errorMsg);
                    $("#resultContainer").addClass("d-none");
                },
                complete: function () {
                    $("#submitBtn").prop("disabled", false).text("提交处理");
                    $("#loadingMessage").addClass("d-none");
                }
            });
        });

        // 显示处理结果（处理结构化数据）
        function displayResult(data) {
            // 清空之前的结果
            $("#resultTitle").text("");
            $("#resultSummary").text("");
            $("#resultImage").attr("src", "").addClass("d-none");

            // 填充标题
            if (data.title) {
                $("#resultTitle").text(data.title);
            } else {
                $("#resultTitle").text("未获取到标题");
            }

            // 填充摘要
            if (data.summary) {
                $("#resultSummary").text(data.summary);
            } else {
                $("#resultSummary").text("未获取到摘要内容");
            }

            // 填充图片（如果有）
            if (data.image) {
                // 假设image字段是图片URL
                $("#resultImage").attr("src", data.image).attr("alt", "处理结果图片").removeClass("d-none");
            }

            // 显示结果容器
            $("#resultContainer").removeClass("d-none");
        }

        // 辅助函数：显示错误提示
        function showError(msg) {
            const errorAlert = $("#errorAlert");
            errorAlert.text(msg).show();
            setTimeout(() => errorAlert.hide(), 5000);
        }

        // 辅助函数：隐藏错误提示
        function hideError() {
            $("#errorAlert").hide();
        }

        // 重置按钮事件
        $("button[type='reset']").click(function () {
            $(".custom-query").hide();
            $("#customQuery").val("");
            $("#resultContainer").addClass("d-none");
            $("#loadingMessage").text("请提交内容进行处理...").removeClass("d-none");
        });
    });
</script>
</body>
</html>